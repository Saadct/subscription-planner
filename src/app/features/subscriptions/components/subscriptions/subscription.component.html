<div class="max-w-5xl mx-auto p-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold">Calendrier des abonnements</h2>
        <button type="button" (click)="openAddDrawer()"
            class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" (keyup.enter)="openAddDrawer()"
            (keyup.space)="openAddDrawer()">
            + Ajouter
        </button>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between items-center mb-4">
        <button type="button" (click)="prevMonth()" (keyup.enter)="prevMonth()" (keyup.space)="prevMonth()"
            class="px-3 py-1 bg-gray-200 rounded">
            ← Mois précédent
        </button>

        <h3 class="text-sm font-semibold">{{ currentMonthName() }} {{ currentYear() }}</h3>

        <button type="button" (click)="nextMonth()" (keyup.enter)="nextMonth()" (keyup.space)="nextMonth()"
            class="px-3 py-1 bg-gray-200 rounded">
            Mois suivant →
        </button>
    </div>

    <!-- Calendrier -->
    <div class="grid grid-cols-7 gap-1">
        <div *ngFor="let day of weekDays" class="text-center font-semibold py-1">{{ day }}</div>
        <div *ngFor="let _ of emptyStartDays" class="border h-20"></div>

        <!-- Cases -->
        <div *ngFor="let day of daysInMonth" class="border h-20 p-1 relative group">
            <div class="absolute top-1 left-1 text-xs font-semibold">{{ day }}</div>

            <ng-container *ngIf="subscriptionsForDay(day).length > 0">
                <!-- Si 2 ou moins abonnements, affichage direct -->
                <ng-container *ngIf="subscriptionsForDay(day).length <= 2">
                    <div *ngFor="let sub of subscriptionsForDay(day)" class="mt-4">
                        <button type="button"
                            class="flex justify-between w-full text-white text-xs rounded px-1 py-0.5 block truncate cursor-pointer"
                            [ngStyle]="{ 'background-color': sub.color || '#3b82f6' }" (click)="openEditDrawer(sub)"
                            (keyup.enter)="openEditDrawer(sub)" (keyup.space)="openEditDrawer(sub)">
                            {{ sub.name }}
                            <button type="button" class="text-white hover:text-red-500 ml-2"
                                (click)="confirmDelete(sub, $event)">
                                ✖
                            </button>
                        </button>
                    </div>
                </ng-container>

                <!-- Si plus de 2 abonnements, afficher +N et tooltip détaillé -->
                <ng-container *ngIf="subscriptionsForDay(day).length > 2">
                    <div class="flex justify-center items-center h-full cursor-pointer" tabindex="0"
                        (click)="openEditDrawer(subscriptionsForDay(day)[0])"
                        (keyup.enter)="openEditDrawer(subscriptionsForDay(day)[0])"
                        (keyup.space)="openEditDrawer(subscriptionsForDay(day)[0])">
                        <div class="text-white text-lg rounded px-2 py-1 bg-gray-700">
                            +{{ subscriptionsForDay(day).length }}
                        </div>
                    </div>

                    <!-- Tooltip avec tous les abonnements cliquables -->
                    <div
                        class="absolute z-20 hidden group-hover:block bg-gray-800 text-white text-xs p-2 rounded shadow-lg top-full left-0 mt-1 w-48">
                        <div *ngFor="let sub of subscriptionsForDay(day)"
                            class="flex justify-between px-1 py-0.5 rounded hover:bg-gray-700">
                            <button type="button" class="w-full text-left flex justify-between"
                                (click)="openEditDrawer(sub)" (keyup.enter)="openEditDrawer(sub)"
                                (keyup.space)="openEditDrawer(sub)">
                                {{ sub.name }} - {{ sub.price | priceEuro }}
                                <button type="button" class="text-white hover:text-red-500 ml-2"
                                    (click)="confirmDelete(sub, $event)">
                                    ✖
                                </button>
                            </button>
                        </div>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </div>
</div>

<!-- Drawers séparés -->
<app-subscription-add [open]="addDrawerOpen" (closeDrawer)="closeAddDrawer()" (save)="saveNewSubscription($event)">
</app-subscription-add>

<app-subscription-edit [open]="editDrawerOpen" [initialData]="selectedSubscription" (closeDrawer)="closeEditDrawer()"
    (update)="updateSubscription($event)">
</app-subscription-edit>